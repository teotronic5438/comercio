{% extends 'base.html' %}

{% block title %}Órdenes Activas{% endblock %}

{% block content %}
<div class="page-container px-4 mt-3">
    <!-- 🔹 Encabezado con ícono -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-clipboard-check text-primary me-2"></i>
            Órdenes Avanzado
        </h2>
        {% if total_ordenes %}
        <span class="badge bg-info text-dark fs-6 px-3 py-2 shadow-sm">
            Total: {{ total_ordenes }}
        </span>
        {% endif %}
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light rounded p-2">
            <li class="breadcrumb-item">
                <i class="bi bi-house-door"></i> Inicio
            </li>
            <li class="breadcrumb-item">
                Órdenes
            </li>
            <li class="breadcrumb-item text-primary" aria-current="page">Avanzado</li>
        </ol>
    </nav>

    <!-- 🔍 Formulario de búsqueda y filtros -->
    <form method="get" class="mb-4 p-3 border rounded-3 shadow-sm bg-light">
        <div class="row g-3 align-items-center">

            <!-- Buscar -->
            <div class="col-md-5">
                <label for="buscar" class="form-label fw-bold mb-1">Buscar por Nº de Serie o Modelo:</label>
                <div class="input-group">
                    <input type="text" id="buscar" name="buscar" class="form-control"
                           placeholder="Buscar..." value="{{ request.GET.buscar }}">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>

            <!-- Estado -->
            <div class="col-md-3">
                <label class="form-label fw-bold mb-1">Filtrar por Estado:</label><br>
                {% for estado in estados %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="estado" value="{{ estado.id }}"
                        {% if estado.id|stringformat:"s" in filtro_estados %}checked{% endif %}>
                    <label class="form-check-label small">{{ estado.nombre_estado }}</label>
                </div>
                {% endfor %}
            </div>

            <!-- Destino -->
            <div class="col-md-3">
                <label class="form-label fw-bold mb-1">Filtrar por Destino:</label><br>
                {% for destino in destinos %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="destino" value="{{ destino.id }}"
                        {% if destino.id|stringformat:"s" in filtro_destinos %}checked{% endif %}>
                    <label class="form-check-label small">{{ destino.nombre_destino }}</label>
                </div>
                {% endfor %}
            </div>

            <!-- Palletizado -->
            <div class="col-md-1 text-center">
                <label class="form-label fw-bold mb-1">¿Palletizado?</label><br>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="palletizado" value="1"
                        {% if "1" in filtro_palletizado %}checked{% endif %}>
                    <label class="form-check-label small">Sí</label>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary px-4 me-2">
                <i class="bi bi-funnel"></i> Filtrar
            </button>
            <a href="{% url 'ordenes_activas' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Limpiar
            </a>
        </div>
    </form>

    <!-- 🧾 Tabla -->
    <div class="table-responsive shadow-sm rounded-3">
        <table class="table table-hover align-middle text-center m-0">
            <thead class="table-header">
                <tr>
                    <th>Acción</th>
                    <th>Orden</th>
                    <th>Modelo</th>
                    <th>Fecha de Creación</th>
                    <th>Tiempo Transcurrido</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for orden in ordenes %}
                <tr>
                    <td>
                        <a href="{% url 'revisar_orden' orden.id %}"
                           class="btn btn-outline-primary btn-sm shadow-sm">
                            Ver detalle
                        </a>
                    </td>
                    <td><strong>ENIGMA-A{{ orden.id }}</strong></td>
                    <td>{{ orden.modelo }}</td>
                    <td>{{ orden.fecha_creacion|date:"d/m/Y H:i" }}</td>
                    <td>
                        {% with orden.tiempo_transcurrido as t %}
                            {{ t.days }} días, {% widthratio t.seconds 3600 1 %} horas
                        {% endwith %}
                    </td>
                    <td>
                        {% if orden.estado == "Pendiente" %}
                            <span class="badge bg-warning text-dark px-3 py-2">Pendiente</span>
                        {% elif orden.estado == "Revisado" %}
                            <span class="badge bg-success px-3 py-2">Revisado</span>
                        {% elif orden.estado == "Palletizado" %}
                            <span class="badge bg-primary px-3 py-2">Palletizado</span>
                        {% elif orden.estado == "Despachado" %}
                            <span class="badge bg-secondary px-3 py-2">Despachado</span>
                        {% else %}
                            <span class="badge bg-light text-dark px-3 py-2">{{ orden.estado }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-muted py-4">No hay órdenes activas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
